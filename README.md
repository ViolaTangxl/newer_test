## 新人训练

### 题目要求
使用gin框架开发文章管理服务的前端接口，至少包括以下字段：文章标题、图片、内容。书写架构设计思路，如何承接千万级的qps。
要求：日活1000万，峰值QPS：10000。文章数量有1千万条。
存储：设计自定义。


接口：
1、文章列表接口，支持排序、分页
2、文章添加接口
3、文章编辑接口

### 系统选型及中间件
#### 存储
考虑到文章可能因来源、类别等不同，文章字段格式与内容大有不同(本次需求中暂未体现)，且数据量较大，使用`mongo`存储文章数据。

#### 缓存
* 由于文章数据量较大，且认为查询需求高于增改需求，大流量情况下，不可能每次都从 `mongo` 实时获取文章信息，因此考虑引入缓存。

主流的缓存 `Redis` 可以满足需求，因此选用`Redis`作为缓存中间件。此处使用的是`gin-cache`作为第三方缓存中间件。 该中间件使用golang.org/x/sync/singleflight，有效的解决缓存击穿问题。

这里有TODO记录: 
* <font color='red'>缓存没有手动删除(新增和修改时) </font>
* <font color='red'>缓存是由接口路由级别的，粒度可能不适用于其他场景 </font>

 结合TODO能否满足业务情况，后面看是否更换缓存中间件

#### 系统框架
根据要求选取`gin`框架进行开发

#### 搜索引擎
如果搜索条件较多，考虑是否接入ES进行文章搜索？

### 备注
#### 存储
全部本地单机测试，没有搭建分布式环境
#### 图片
* 考虑到图片字段，假设文章中图片的大小在录入时有限制，不会出现大图(16M以上)的情况，所以单独不使用 `gridfs`
* 单独的图片字段，假设业务中每篇文章有个默认图片的场景，非文章正文中出现的插图。为方便理解，称为头图
* 如果是文章正文中的插图，前端编辑文章时可以使用上传插件，后端文章正文字段中直接存储`bucket`的`url`？

### TODO List
* <font color='red'> 缓存仅加在了List接口，没有做增改操作对已有key的删除 </font>
* 分页查询优化，如果不考虑跳转到指定页的情况（仅上一页、下一页），可以不用`skip`方法，而是每次记录最后一个or第一个ObjectID，使用
`Select(bson.M{"origin_id": 1, "_id": 1}). Limit(limit).`去查询，会快捷很多
* 
####  如果是`Redis`集群的情况下
* 热点`key`可以加随机后缀，保存在多个`redis`节点上，有的有过期时间，有的没有，如果查不到（有过期时间的缓存已经失效），则查DB，修改缓存，返回缓存数据
* `Redis`中文章记录存储为`value`，很可能`value`特别大影响性能，考虑将对象拆分为多个`K.V`，使用`multiGet`获取值，
降低单次操作的压力，将压力平摊到多个`Redis`实例上
* 也可将这个大对象存储在一个`hash`，每个`field`代表一个具体属性。`hget`、`hmget`获取部分`value`.`hset`，`hmset`来更新部分属性


#### 代码层面
* 公共方法抽取、环境变量（如端口号) 抽取到配置文件
* 错误日志记录

### 自测过程
#### 小数据量新建文章 
POST localhost:11009/articles
![](img/1.png)
![](img/2.png)

#### 小数据量新建文章
PUT localhost:11009/articles
* 没有带`id`字段
![](img/3.png)
![](img/4.png)

* 正确修改
![](img/5.png)
![](img/6.png)

#### 小数据量分页查询文章
GET localhost:11009/articles/list
* 全部查询，默认10条
  ![](img/7.png)

* 标题模糊查询
  ![](img/8.png)


#### 批量插入1000W数据单测
![](img/9.png)
![](img/10.png)

#### 分页接口排序
![](img/11.png)

#### 增加缓存后分页接口查询时间
对比上图可发现，增加缓存后，接口单次查询时间由2992ms变为9ms
![](img/12.png)

#### 压测
压测使用的工具是 https://github.com/link1st/go-stress-testingccc
![](img/13.png)